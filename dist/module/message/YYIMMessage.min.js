YYIMChat=function(e){var t=e.constructor,n=function(){function t(){e.getConnection().registerHandler(OPCODE.USER_MESSAGE.KEY,function(t){o(t,e.getConstants().CHAT_TYPE.CHAT)}),e.getConnection().registerHandler(OPCODE.CHATGROUP_MESSAGE.KEY,function(t){o(t,e.getConstants().CHAT_TYPE.GROUP_CHAT)}),e.getConnection().registerHandler(OPCODE.PUBACCOUNT_MESSAGE.KEY,function(t){o(t,e.getConstants().CHAT_TYPE.PUB_ACCOUNT)}),e.getConnection().registerHandler(OPCODE.RECEIPTS.KEY,function(t){t.type=e.getJIDUtil().getChatTypeByJid(t.to),t.from=e.getJIDUtil().getID(t.from),t.to=e.getJIDUtil().getID(t.to),e.onReceipts(t)}),e.getConnection().registerHandler(OPCODE.SYNC_MESSAGE.KEY,function(e){o(e,e.type)}),e.getConnection().registerHandler(OPCODE.USERONLINEDELIVERPACKET.KEY,function(t){n(t,e.getConstants().CHAT_TYPE.CHAT)}),e.getConnection().registerHandler(OPCODE.MUCONLINEDELIVERPACKET.KEY,function(t){n(t,e.getConstants().CHAT_TYPE.GROUP_CHAT)}),e.getConnection().registerHandler(OPCODE.PUBONLINEDELIVERPACKET.KEY,function(t){n(t,e.getConstants().CHAT_TYPE.PUB_ACCOUNT)}),e.getConnection().registerHandler(OPCODE.REMINDSETTINGONLINEDELIVERPACKET.KEY,function(e){n(e)})}function n(t,n){if(!T.get(t.id)){if(T.set(t.id,t),t.type=n||e.getJIDUtil().getChatTypeByJid(t.from),t.to=e.getJIDUtil().getID(t.to)||e.getUserID(),t.from=t.type!=e.getConstants().CHAT_TYPE.GROUP_CHAT?e.getJIDUtil().getID(t.from):{room:e.getJIDUtil().getID(t.from),roster:e.getJIDUtil().getID(e.getJIDUtil().getResource(t.from))},t.attributes&&(t.attributes.receiver&&(t.attributes.receiver=e.getJIDUtil().getID(t.attributes.receiver)),t.attributes.bareJID&&(t.attributes.bareJID={id:e.getJIDUtil().getID(t.attributes.bareJID),type:e.getJIDUtil().getChatTypeByJid(t.attributes.bareJID)}),t.attributes.userJids&&e.getUtil().isWhateType(t.attributes.userJids,"Array")))for(var s in t.attributes.userJids)t.attributes.userJids.hasOwnProperty(s)&&(t.attributes.userJids[s]=e.getJIDUtil().getID(t.attributes.userJids[s]));try{e.onTransparentMessage(t)}catch(n){e.log("TransparentMessHandleError:",0,t)}}}function s(t,n){var s;try{if((s=JSON.parse(t.content))&&s.content)try{isNaN(Number(s.content))&&t.contentType!=e.getConstants().MESSAGE_CONTENT_TYPE.TEXT&&(s.content=JSON.parse(s.content))}catch(e){}}catch(e){s=t.content}var o=s;void 0!==s.content&&(o=s.content);var r={content:o,contentType:t.contentType,dateline:t.dateline||t.ts,atuser:s.atuser,extend:s.extend};if(t.contentType==e.getConstants().MESSAGE_CONTENT_TYPE.MERGEFORWARD&&(r.title=s.title,r.containfileNum=s.containfileNum,r.safeMode=s.safeMode,s.messages)){r.messages=[];for(var i in s.messages)if(s.messages.hasOwnProperty(i)){var d=arguments.callee(s.messages[i],n);d&&r.messages.push(d)}}var c=n==e.getConstants().CHAT_TYPE.CHAT?e.getJIDUtil().getID(t.sender||t.from):{room:e.getJIDUtil().getID(t.mucid||t.sender||t.from),roster:e.getJIDUtil().getID(e.getJIDUtil().getResource(t.sender||t.from)||t.sender)},g={id:t.id||t.packetId,type:n,from:c,dateline:r.dateline,sessionVersion:t.sessionVersion,data:r};if(n==e.getConstants().CHAT_TYPE.CHAT?(g.resource=e.getJIDUtil().getResource(t.sender||t.from),g.to=e.getJIDUtil().getID(t.receiver||t.to)):g.to=e.getUserID(),r.contentType)return g.data.content&&g.data.content.path&&(g.data.content.attachId=g.data.content.path,g.data.content.path=e.getFileUrl(g.data.content.path),r.contentType!=e.getConstants().MESSAGE_CONTENT_TYPE.FILE&&r.contentType!=e.getConstants().MESSAGE_CONTENT_TYPE.IMAGE||(g.data.content.size=g.data.content.size||0)),!g.data||!0!==t.receipts&&e.getJIDUtil().getID(t.sender||t.from)==e.getUserID()||(g.data.receipt={to:t.mucid||t.sender||t.from,id:t.id||t.packetId,type:n,sessionVersion:t.sessionVersion},!0===t.receipts&&a(g.data.receipt)),g}function o(t,n){if(!T.get(t.id)){T.set(t.id,t);var o=s(t,n);if(o)try{e.onMessage(o)}catch(t){e.log("ParseMessageError:",0,o,t)}}}function a(t){t=t||{};var n=e.getJIDUtil().buildUserJID(e.getJIDUtil().getNode(t.to));t.type==e.getConstants().CHAT_TYPE.GROUP_CHAT?n=e.getJIDUtil().buildChatGroupJID(e.getJIDUtil().getNode(t.to)):t.type==e.getConstants().CHAT_TYPE.PUB_ACCOUNT&&(n=e.getJIDUtil().buildPubAccountJID(e.getJIDUtil().getNode(t.to)));var s=new JumpPacket({to:n,dateline:(new Date).getTime(),sessionVersion:t.sessionVersion,id:t.id,state:t.state},OPCODE.RECEIPTS.SEND);e.getConnection().send(s)}function r(t){var n=t.body||{};if(n.extend&&"string"!=typeof n.extend)try{n.extend=JSON.stringify(n.extend)}catch(t){delete n.extend,e.log("ExtendIllegal",0,t.message)}var s,o={id:t.id,spaceId:t.spaceId,type:t.type||e.getConstants().CHAT_TYPE.CHAT,contentType:n.contentType||e.getConstants().MESSAGE_CONTENT_TYPE.TEXT,dateline:n.dateline||(e.getConfig().TIMECORRECTION.AUTOCORRECTION?(new Date).getTime()+e.getConfig().TIMECORRECTION.RESULT:(new Date).getTime()),content:JSON.stringify({atuser:n.atuser,extend:n.extend,content:n.content})},a=OPCODE.USER_MESSAGE.SEND;n.contentType&&n.contentType!=e.getConstants().MESSAGE_CONTENT_TYPE.TEXT||t.type!=e.getConstants().CHAT_TYPE.GROUP_CHAT||YYIMUtil.isWhateType(n.atuser,"Array")&&n.atuser.length&&(-1!=n.atuser.indexOf("im_atall")?o.statRead=1:(o.statRead=2,o.statMem=n.atuser)),t.type==e.getConstants().CHAT_TYPE.GROUP_CHAT?(s=e.getJIDUtil().buildChatGroupJID(e.getJIDUtil().getNode(t.to)),a=OPCODE.CHATGROUP_MESSAGE.SEND):t.type==e.getConstants().CHAT_TYPE.PUB_ACCOUNT?(s=e.getJIDUtil().buildPubAccountJID(e.getJIDUtil().getNode(t.to)),a=OPCODE.PUBACCOUNT_MESSAGE.SEND):(o.receipts="1",s=t.resource&&t.to==e.getUserID()?e.getJIDUtil().buildUserJID(e.getJIDUtil().getNode(t.to),t.resource):e.getJIDUtil().buildUserJID(e.getJIDUtil().getNode(t.to))),o.to=s,e.getConnection().send(new JumpPacket(o,a),function(s){40302==s.code?(t.error&&t.error(),t=null):e.getConfig().TIMECORRECTION.AUTOCORRECTION?s&&1==s.state&&e.onReceipts(s):(t.success&&t.success(i(t,n,s)),t=null)}),e.getConfig().TIMECORRECTION.AUTOCORRECTION&&t.success&&t.success(i(t,n,{dateline:o.dateline}))}function i(t,n,s){var o={id:t.id,type:t.type,sessionVersion:s.sessionVersion||0,data:{content:n.content,contentType:n.contentType,dateline:s.dateline,extend:n.extend}};return o.type!=e.getConstants().CHAT_TYPE.CHAT?(o.to=e.getUserID(),o.from={room:e.getJIDUtil().getID(t.to),roster:e.getUserID()}):(o.to=e.getJIDUtil().getID(t.to),o.from=e.getUserID(),o.resource=e.getResource()),o.data.content.path&&(o.data.content.attachId=o.data.content.path,o.data.content.path=e.getFileUrl(o.data.content.path)),o}function d(t){var n,s,o={token:e.getToken(),start:t.start||0,size:t.size||100};if(t.type==e.getConstants().CHAT_TYPE.GROUP_CHAT)s="groupchat";else if(t.type==e.getConstants().CHAT_TYPE.PUB_ACCOUNT)s="pubaccount";else if(s="user",t.contentType){var a=e.getConstants().MESSAGE_CONTENT_TYPE;for(var r in a)if(t.contentType==a[r]){o.contentType=t.contentType;break}}n=e.getConfig().SERVLET.REST_USER_SERVLET+e.getConfig().MULTI_TENANCY.ETP_KEY+"/"+e.getConfig().MULTI_TENANCY.APP_KEY+"/"+e.getUserID()+"/msghistory/"+s+"/"+t.id+"/version/"+(t.startVersion||0)+"/"+t.endVersion,n+="?"+jQuery.param(o),e.log("历史记录：request URL",2,n),jQuery.ajax({url:n,dataType:"json",cache:!1,success:function(e){c(e,t),t=null},error:function(n){e.log("getHistoryMessage_error:",0,n.statusText);try{t.error&&t.error(JSON.parse(n.responseText)),t=null}catch(e){t.error&&t.error(),t=null}}})}function c(t,n){e.log("历史记录：data",2,t);var o=[];for(var a in t.list)if(t.list.hasOwnProperty(a)){var r=t.list[a],i=s(r,n.type);o.push(i)}n.success&&n.success({contactReadVersion:t.contactReadVersion,total:t.total,result:o})}function g(t){var n,s;t.type==e.getConstants().CHAT_TYPE.GROUP_CHAT?(n=e.getConfig().SERVLET.REST_USER_SERVLET+e.getConfig().MULTI_TENANCY.ETP_KEY+"/"+e.getConfig().MULTI_TENANCY.APP_KEY+"/revokeservice/groupmessage/"+t.id,s={token:e.getToken(),userid:e.getUserNode(),mucid:e.getJIDUtil().getNode(t.to)}):(n=e.getConfig().SERVLET.REST_USER_SERVLET+e.getConfig().MULTI_TENANCY.ETP_KEY+"/"+e.getConfig().MULTI_TENANCY.APP_KEY+"/revokeservice/personalmessage/"+t.id,s={token:e.getToken(),fromuserid:e.getUserNode(),touserid:e.getJIDUtil().getNode(t.to)}),n+="?"+jQuery.param(s),jQuery.ajax({url:n,type:"post",cache:!1,success:function(e){t.success&&t.success({id:t.id}),t=null},error:function(e){try{t.error&&t.error(JSON.parse(e.responseText)),t=null}catch(e){t.error&&t.error(),t=null}}})}var T=new BaseList;return{monitor:t,sendMessage:r,getHistoryMessage:d,revokeMessage:g,sendReceiptsPacket:a}}();return e.setBackhander({monitor:{messageMonitor:n.monitor},initCallback:{message:function(t){e.onReceipts=t.onReceipts||function(){},e.onMessage=t.onMessage||function(){},e.onTransparentMessage=t.onTransparentMessage||function(){}}}}),t.prototype.getHistoryMessage=function(e){e=e||{},YYIMUtil.isWhateType(e.start,"Number")||(e.start=0),YYIMUtil.isWhateType(e.size,"Number")||(e.size=100),n.getHistoryMessage(e)},t.prototype.sendReadedReceiptsPacket=function(e){e&&e.id&&(e.state=2,n.sendReceiptsPacket(e))},t.prototype.sendFormMessage=function(t){var n=this,s=t.file,o={token:this.getToken(),creator:this.getUserNode(),receiver:this.getJIDUtil().getNode(t.to),mediaType:t.mediaType||2,randomId:Math.uuid(),name:s.name,size:s.size},a=e.getConfig().SERVLET.REST_RESOURCE_SERVLET+e.getConfig().MULTI_TENANCY.ETP_KEY+"/"+e.getConfig().MULTI_TENANCY.APP_KEY+"/upload";a+="?"+jQuery.param(o),jQuery.ajax({xhr:function(){var e=new window.XMLHttpRequest;return e.upload.addEventListener("progress",function(e){if(e.lengthComputable){var n=e.loaded/e.total;t.progress&&t.progress({loaded:e.loaded,total:e.total,percent:n})}},!1),e.addEventListener("progress",function(e){if(e.lengthComputable){var n=e.loaded/e.total;t.progress&&t.progress({loaded:e.loaded,total:e.total,percent:n})}},!1),e},url:a,type:"post",dataType:"json",data:t.data,processData:!1,contentType:!1,success:function(a){if(a&&a.attachId){var r=e.getConstants().MESSAGE_CONTENT_TYPE;t.fileUploaded&&t.fileUploaded(a),n.sendMessage({id:t.id,to:t.to,spaceId:t.spaceId,type:t.type,content:new IMFile({name:s.name,path:a.attachId,size:s.size,original:1===o.mediaType?1:null}),contentType:1===o.mediaType?r.IMAGE:r.FILE,success:t.success,error:t.error})}else t.error&&t.error();t=null},error:t.error})},t.prototype.sendShareMessage=function(t){t.contentType=e.getConstants().MESSAGE_CONTENT_TYPE.SHARE,this.sendMessage(t)},t.prototype.sendTextMessage=function(t){t.content=t.msg||t.content,t.contentType=e.getConstants().MESSAGE_CONTENT_TYPE.TEXT,this.sendMessage(t)},t.prototype.sendMessage=function(t){t.id=t.id||Math.uuid(),t.type=t.type||e.getConstants().CHAT_TYPE.CHAT,t.body={dateline:t.dateline,extend:t.extend,content:t.content,contentType:t.contentType},t.type===e.getConstants().CHAT_TYPE.GROUP_CHAT&&YYIMArrayUtil.isArray(t.atuser)&&(t.body.atuser=t.atuser),n.sendMessage(t)},t.prototype.revokeMessage=function(e){e&&e.id?n.revokeMessage(e):e&&e.error&&e.error()},t.prototype.sendPic=function(t){t=t||{},YYIMUtil.isWhateType(t.chatInfo,"Function")?this.uploader(jQuery("#"+t.fileInputId)[0]||t.fileInputId,{drop_element:t.drop_element,chatInfo:t.chatInfo,fileFiltered:t.fileFiltered,beforeUpload:t.beforeUpload,mediaType:1,success:function(s){n.sendMessage({id:s.chatInfo.messageId||Math.uuid(),spaceId:s.chatInfo.spaceId,body:{extend:s.chatInfo.extend,content:new IMFile({id:s.file.id,name:s.file.name,path:s.data&&s.data.attachId,size:s.file.size,original:1}),contentType:e.getConstants().MESSAGE_CONTENT_TYPE.IMAGE},to:s.chatInfo.to,type:s.chatInfo.type,success:function(e){t.success&&t.success(e)}}),t.fileUploaded&&t.fileUploaded(s)},error:t.error,progress:t.progress}):t&&t.error&&t.error()},t.prototype.sendFile=function(t){var s=this;t=t||{},YYIMUtil.isWhateType(t.chatInfo,"Function")?this.uploader(jQuery("#"+t.fileInputId)[0]||t.fileInputId,{drop_element:t.drop_element,chatInfo:t.chatInfo,fileFiltered:t.fileFiltered,beforeUpload:t.beforeUpload,mediaType:3,success:function(o){var a=3;e.getConfig().UPLOAD.IMAGE_TYPES.test(o.file.name)&&(a=1);var r=new IMFile({id:o.file.id,name:o.file.name,path:o.data&&o.data.attachId,size:o.file.size});1===a&&r.build({original:1}),o&&o.data&&o.data.data&&o.data.data.fileUrl&&r.build({path:o.data.data.fileUrl,fid:o.data.data.fid}),YYIMUtil.isWhateType(o.data,"Array")&&(r=new IMFile({id:o.file.id,name:o.file.name,path:o.data[4],size:o.file.size,fid:o.data[0]})),n.sendMessage({id:o.chatInfo.messageId||Math.uuid(),spaceId:o.chatInfo.spaceId,body:{extend:o.chatInfo.extend,content:r,contentType:1===a?s.getConstants().MESSAGE_CONTENT_TYPE.IMAGE:s.getConstants().MESSAGE_CONTENT_TYPE.FILE},to:o.chatInfo.to,type:o.chatInfo.type,success:function(e){t.success&&t.success(e)}}),t.fileUploaded&&t.fileUploaded(o)},error:t.error,progress:t.progress}):t&&t.error&&t.error()},t.getInstance()}(YYIMChat);