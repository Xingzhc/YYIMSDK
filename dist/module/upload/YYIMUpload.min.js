YYIMChat=function(e){function t(){}var n=e.constructor;return t.prototype=new BaseList,t.getInstance=function(){return this._instance||(this._instance=new t),this._instance},t.prototype.init=function(t,n){var i={browse_button:"fileUpload",file_data_name:"file",url:this.getBaseUrl(),filters:{max_file_size:"100mb",prevent_duplicates:!!e.getConfig().UPLOAD.PREVENT_DUPLICATES},flash_swf_url:e.getConfig().UPLOAD.FLASH_SWF_URL,silverlight_xap_url:e.getConfig().UPLOAD.SILVERLIGHT_XAP_URL,multi_selection:!!e.getConfig().UPLOAD.MULTI_SELECTION,multipart:!0,max_retries:1,chunk_size:0,runtimes:"gears,html5,flash,silverlight,browserplus"};t.mediaType==e.getConfig().UPLOAD.MEDIATYPE.IMAGE?i.filters.mime_types=[{title:"Image files",extensions:"jpg,gif,png,jpeg,bmp"}]:i.filters.mime_types=void 0,jQuery.extend(i,t);var o=(i.browse_button,new plupload.Uploader(i));o.init(),o.refresh(),this.bindEvents(o,n)},t.prototype.getBaseUrl=function(){return e.getServletPath().REST_RESOURCE_SERVLET+e.getTenancy().ETP_KEY+"/"+e.getTenancy().APP_KEY+"/upload"},t.prototype.getUploadingSize=function(){var e=0;for(var t in this.list)if(this.list.hasOwnProperty(t)){var n=this.list[t];if(n){var i=n.getFile(t);i.status!=plupload.FAILED&&i.status!=plupload.STOPPED&&e++}}return e},t.prototype.start=function(e){var t;e&&(t=this.get(e.id||e))&&(e=t.getFile(e.id||e),e&&(e.status=1),t.start())},t.prototype.end=function(e){var t;if(e){var n=e.id||e;t=this.get(n),t&&(e=t.getFile(n),e&&t.removeFile(e),this.remove(n))}else this.forEach(function(e){e.splice(0),e.destroy()}),this.clear()},t.prototype.bindEvents=function(e,t){var n=this;e.bind("init",function(e){t&&t.init&&t.init(e)}),e.bind("PostInit",function(e){t&&t.PostInit&&t.PostInit(e)}),e.bind("Refresh",function(e){t&&t.Refresh&&t.Refresh(e)}),e.bind("StateChanged",function(e){t&&t.StateChanged&&t.StateChanged(e)}),e.bind("UploadFile",function(e,n){t&&t.StateChanged&&t.UploadFile(e,n)}),e.bind("BeforeUpload",function(e,n){t&&t.BeforeUpload&&t.BeforeUpload(e,n)}),e.bind("QueueChanged",function(e){t&&t.QueueChanged&&t.QueueChanged(e)}),e.bind("OptionChanged",function(e,n,i,o){t&&t.OptionChanged&&t.OptionChanged(e,n,i,o)}),e.bind("UploadProgress",function(e,n){t&&t.UploadProgress&&t.UploadProgress(e,n)}),e.bind("FilesAdded",function(e,n){t&&t.FilesAdded&&t.FilesAdded(e,n)}),e.bind("FilesRemoved",function(e,i){i.forEach(function(e,t){n.remove(e.id)}),t&&t.FilesRemoved&&t.FilesRemoved(e,i)}),e.bind("FileFiltered",function(e,i){n.set(i.id,e),t&&t.FileFiltered&&t.FileFiltered(e,i)}),e.bind("FileUploaded",function(e,n,i){t&&t.FileUploaded&&t.FileUploaded(e,n,i)}),e.bind("ChunkUploaded",function(e,n,i){t&&t.ChunkUploaded&&t.ChunkUploaded(e,n,i)}),e.bind("UploadComplete",function(e,n){t&&t.UploadComplete&&t.UploadComplete(e,n)}),e.bind("Error",function(e,n){t&&t.Error&&t.Error(e,n)}),e.bind("Destroy",function(e){t&&t.Destroy&&t.Destroy(e)})},n.getInstance().uploader=function(n,i){if(i=i||{},"string"==typeof n&&(n=document.getElementById(n)),!YYIMUtil.isWhateType(i.chatInfo,"Function"))return void(i.error&&i.error("chatInfo isn`t Function."));t.getInstance().init({mediaType:i.mediaType||e.getConfig().UPLOAD.MEDIATYPE.DOC,browse_button:n.id,drop_element:i.drop_element},{init:function(e){e.addFile(n),n=null},PostInit:function(e){},Refresh:function(e){},StateChanged:function(e){},UploadFile:function(e,t){},BeforeUpload:function(n,o){var r=n.getOption("chatInfo");if(r){var a=r[o.id];if(a){try{i.beforeUpload&&i.beforeUpload({file:o,chatInfo:a})}catch(e){}var l=n.getOption("mediaType");if(e.getConfig().UPLOAD.IMAGE_TYPES.test(o.name)&&(l=1),a.file_data_name&&n.setOption("file_data_name",a.file_data_name),a.required_features&&n.setOption("required_features",a.required_features),1!==l&&a.uploadUrl)n.setOption("url",a.uploadUrl);else{var s=e.getJIDUtil().buildUserJID(e.getJIDUtil().getNode(a.to));a.type&&a.type==e.getConstants().CHAT_TYPE.GROUP_CHAT&&(s=e.getJIDUtil().buildChatGroupJID(e.getJIDUtil().getNode(a.to))),n.setOption("url",t.getInstance().getBaseUrl()+"?"+jQuery.param({token:e.getToken(),name:o.name,mediaType:l,creator:e.getUserNode(),receiver:s,type:o.type,size:o.size,original:1}))}}}},QueueChanged:function(e){},OptionChanged:function(e,t,n,i){},UploadProgress:function(e,t){var n,o=e.getOption("chatInfo");o&&(n=o[t.id]),i&&i.progress&&i.progress({uploaded:e.total.uploaded,queued:e.total.queued,bytesPerSec:e.total.bytesPerSec,percent:e.total.percent,size:e.total.size,loaded:e.total.loaded,file:t,chatInfo:n})},FilesAdded:function(t,n){e.getConfig().UPLOAD.AUTO_SEND&&t.start()},FilesRemoved:function(e,t){},FileFiltered:function(e,t){var n=i.chatInfo({fileName:t.name});if(n&&n.to)if(!YYIMUtil.isWhateType(n.checkType,"Function")||n.checkType(t.getSource().type)){var o=e.getOption("chatInfo")||{};o[t.id]=n,e.setOption("chatInfo",o),i&&i.fileFiltered&&i.fileFiltered({file:t,chatInfo:n})}else e.removeFile(t),i&&i.error&&i.error({file:t,chatInfo:n,error:"格式不支持"});else e.removeFile(t),i&&i.error&&i.error({file:t,chatInfo:n,error:"请指定接收方"})},FileUploaded:function(e,n,o){if(200===o.status){var r=e.getOption("chatInfo");n&&n.getNative()&&(n.path=n.getNative().path);var a=r[n.id];try{var l=JSON.parse(o.response);0===l.code||l.attachId||l[0]?(delete r[n.id],e.setOption("chatInfo",r),e.removeFile(n),t.getInstance().remove(n.id),i&&i.success&&i.success({data:l,file:n,chatInfo:a})):i&&i.error&&i.error({data:l,file:n,chatInfo:a})}catch(e){i&&i.error&&i.error({data:e.message,file:n,chatInfo:a})}}},ChunkUploaded:function(e,t,n){},UploadComplete:function(e,t){},Error:function(e,t){var n=t.file,o=e.getOption("chatInfo");o&&(t.chatInfo=o[n.id]),i&&i.error&&i.error(t)},Destroy:function(e){}})},n.prototype.startUpload=function(e){t.getInstance().start(e)},n.prototype.cancelUpload=function(e){t.getInstance().end(e)},n.prototype.getUploadingSize=function(){return t.getInstance().getUploadingSize()},n.prototype.previewLocalImage=function(e){e=e||{};var t=e.file;if(t&&/image\//.test(t.type)){try{if("image/gif"==t.type){var n=new moxie.file.FileReader;n.onload=function(){e.success&&e.success(n.result),n.destroy(),n=null},n.readAsDataURL(t.getSource())}else{var i=new moxie.image.Image;i.onload=function(){var t="image/jpeg"==i.type?i.getAsDataURL("image/jpeg",80):i.getAsDataURL();e.success&&e.success(t),i.destroy(),i=null},i.load(t.getSource())}}catch(t){e.error&&e.error("Local address parsing errors.")}}else e.error&&e.error("The file isn`t Image.")},n.getInstance()}(YYIMChat);